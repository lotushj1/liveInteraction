# 系統容量評估指南

## 📊 Supabase Realtime 並發限制

### 官方限制（按計劃）

| 計劃 | 最大並發連接數 | 每秒消息數 | 推薦使用場景 |
|------|---------------|-----------|-------------|
| **Free** | 200 | 100 | 開發/測試 |
| **Pro** | 500 | 500 | 小型應用 |
| **Team** | 1,000 | 1,000 | 中型應用 |
| **Enterprise** | 自定義 | 自定義 | 大型應用 |

> 注意: 實際可用連接數還取決於數據庫性能、網絡條件等因素

## 🎯 LiveInteraction 系統容量預估

### 基於 Supabase Free Plan

**安全並發容量:**
- **穩定支持**: 50-100 個並發用戶
- **峰值支持**: 150 個並發用戶
- **不推薦**: 超過 200 個用戶

**建議使用場景:**
- ✅ 小班教學 (10-30 人)
- ✅ 中型研討會 (30-80 人)
- ⚠️  大型講座 (80-150 人，需優化)
- ❌ 超大型活動 (150+ 人，需升級方案)

### 基於 Supabase Pro Plan

**安全並發容量:**
- **穩定支持**: 200-300 個並發用戶
- **峰值支持**: 400 個並發用戶
- **不推薦**: 超過 500 個用戶

**建議使用場景:**
- ✅ 大型講座 (100-200 人)
- ✅ 全校活動 (200-300 人)
- ⚠️  超大型活動 (300-400 人，需優化)

## 🔍 性能基準參考

### 良好性能指標

```
✅ 成功連接率: ≥ 99%
✅ 平均連接時間: < 500ms
✅ 錯誤率: < 1%
✅ 消息延遲: < 200ms
```

### 可接受性能指標

```
⚠️  成功連接率: 95-99%
⚠️  平均連接時間: 500-1000ms
⚠️  錯誤率: 1-5%
⚠️  消息延遲: 200-500ms
```

### 需要優化的性能指標

```
❌ 成功連接率: < 95%
❌ 平均連接時間: > 1000ms
❌ 錯誤率: > 5%
❌ 消息延遲: > 500ms
```

## 💡 不同規模活動的測試建議

### 小型活動 (10-30 人)

**測試方案:**
```bash
npm run test:light
```

**預期結果:**
- 成功率: 100%
- 連接時間: 200-400ms
- 零錯誤

**優化重點:**
- 無需特別優化
- 關注用戶體驗

---

### 中型活動 (30-80 人)

**測試方案:**
```bash
npm run test:medium
npm run test:heavy
```

**預期結果:**
- 成功率: 99%+
- 連接時間: 300-600ms
- 錯誤率 < 1%

**優化重點:**
- 優化消息頻率
- 監控數據庫查詢
- 考慮使用 CDN

---

### 大型活動 (80-200 人)

**測試方案:**
```bash
npm run test:stress
npm run test:batch
```

**預期結果:**
- 成功率: 95-99%
- 連接時間: 500-1000ms
- 錯誤率 < 3%

**優化重點:**
- ⚠️  必須優化實時訂閱
- 實施消息批處理
- 使用數據庫連接池
- 考慮升級 Supabase 計劃
- 添加限流機制

---

### 超大型活動 (200+ 人)

**測試方案:**
```bash
npm run test:extreme
```

**預期結果:**
- ⚠️  可能達到系統限制
- 需要 Pro+ 計劃
- 需要架構優化

**必要優化:**
- ❗ 升級到 Supabase Pro/Team 計劃
- 實施分區策略（按房間/頻道分組）
- 使用 Redis 緩存
- 考慮 WebSocket 負載均衡
- 實施智能降級策略

## 🛠️ 擴展策略

### 水平擴展（推薦）

1. **房間分組**
   - 將用戶分散到多個房間
   - 每個房間限制 50-100 人
   - 減少單一頻道壓力

2. **分區廣播**
   - 僅向相關用戶廣播消息
   - 使用 Presence 分組
   - 減少不必要的消息傳輸

3. **漸進式加載**
   - 用戶分批加入
   - 延遲非關鍵功能載入
   - 優化初始化流程

### 垂直擴展

1. **升級 Supabase 計劃**
   - Free → Pro: 支持 2.5x 並發
   - Pro → Team: 支持 2x 並發

2. **數據庫優化**
   - 添加適當索引
   - 優化查詢語句
   - 使用數據庫連接池

3. **基礎設施優化**
   - 使用 CDN 加速靜態資源
   - 啟用 gzip 壓縮
   - 優化圖片和媒體資源

## 📈 測試策略

### 階段性測試

```bash
# 階段 1: 基礎驗證 (5-10 人)
npm run test:micro

# 階段 2: 小規模測試 (10-25 人)
npm run test:light

# 階段 3: 中規模測試 (25-50 人)
npm run test:medium

# 階段 4: 大規模測試 (50-100 人)
npm run test:heavy

# 階段 5: 壓力測試 (100-200 人)
npm run test:stress

# 階段 6: 極限測試 (200+ 人)
npm run test:extreme
```

### 持續監控

**測試頻率:**
- 每次重大更新後
- 每月至少一次回歸測試
- 大型活動前必須測試

**監控指標:**
- Supabase Dashboard 實時監控
- 應用程序日誌分析
- 用戶反饋收集

## 🚨 預警機制

### 需要升級的信號

1. **Free Plan 用戶:**
   - 定期有 80+ 並發用戶
   - 經常出現連接失敗
   - 用戶反饋延遲問題

2. **Pro Plan 用戶:**
   - 定期有 300+ 並發用戶
   - 錯誤率持續 > 3%
   - 需要更細粒度控制

### 架構優化的信號

- 消息吞吐量達到計劃限制 80%
- 數據庫查詢變慢
- 用戶體驗明顯下降
- 成本效益不佳

## 📞 故障排除

### 常見問題

**Q: 測試顯示支持 100 人，但實際只能支持 50 人？**

A: 可能原因：
- 測試環境與生產環境配置不同
- 實際用戶操作更頻繁
- 網絡條件差異
- 其他後台任務占用資源

**Q: 如何提升並發容量但不升級計劃？**

A: 優化建議：
1. 減少不必要的實時訂閱
2. 優化消息發送頻率
3. 實施客戶端緩存
4. 使用分組/分區策略
5. 延遲加載非關鍵功能

**Q: 什麼時候應該考慮自建 WebSocket 服務？**

A: 考慮因素：
- 需要支持 1000+ 並發
- Supabase Enterprise 成本過高
- 需要極致自定義控制
- 有專業運維團隊

## 🎓 最佳實踐總結

1. **測試先行**: 活動前必須進行負載測試
2. **預留空間**: 實際並發數應為測試容量的 70-80%
3. **階梯定價**: 根據實際需求選擇 Supabase 計劃
4. **持續優化**: 定期審查和優化系統性能
5. **降級策略**: 準備應急降級方案
6. **用戶溝通**: 提前告知用戶系統容量限制

---

**注意**: 本指南基於 Supabase 官方文檔和實際測試經驗，具體數據可能因環境而異，請以實際測試結果為準。
