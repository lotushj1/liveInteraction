# LiveInteraction 並發負載測試系統

## 📋 概述

本項目已建立完整的並發負載測試系統，用於評估 LiveInteraction 實時互動平台可以同時支持多少用戶使用。

## 🎯 測試目的

1. **評估系統容量**: 確定系統可以穩定支持的最大並發用戶數
2. **性能基準測試**: 建立性能指標基準，用於持續監控
3. **容量規劃**: 為不同規模的活動提供容量規劃建議
4. **優化指導**: 識別性能瓶頸，提供優化方向

## 📁 項目結構

```
load-testing/
├── user-simulator.js      # 用戶行為模擬器
├── test-runner.js         # 測試運行器（核心）
├── quick-test.js          # 互動式測試啟動器
├── batch-test.js          # 批量測試腳本
├── package.json           # NPM 配置和腳本
├── .env.example           # 環境變量模板
├── .gitignore            # Git 忽略配置
├── README.md             # 完整使用文檔
├── QUICK_START.md        # 快速開始指南
├── CAPACITY_GUIDE.md     # 容量評估指南
└── reports/              # 測試報告目錄（自動生成）
```

## 🚀 核心功能

### 1. 用戶模擬器 (user-simulator.js)

模擬真實用戶行為：
- ✅ 建立 Supabase Realtime 連接
- ✅ 追蹤用戶在線狀態（Presence）
- ✅ 訂閱實時廣播頻道
- ✅ 模擬用戶互動（答題、切換頁面等）
- ✅ 收集性能指標

### 2. 測試運行器 (test-runner.js)

管理測試流程：
- ✅ 逐步啟動用戶（模擬真實場景）
- ✅ 並發活動模擬
- ✅ 性能監控
- ✅ 錯誤追蹤
- ✅ 報告生成

### 3. 快速測試 (quick-test.js)

互動式測試啟動：
- ✅ 6 個預設測試場景
- ✅ 自定義測試選項
- ✅ 友好的用戶界面

### 4. 批量測試 (batch-test.js)

自動化測試：
- ✅ 運行多個測試場景
- ✅ 生成對比報告
- ✅ 評估系統容量上限

## 📊 測試場景

| 場景 | 並發數 | 測試時長 | 適用範圍 | 命令 |
|------|-------|---------|---------|------|
| 微型 | 5 | 30秒 | 開發驗證 | `npm run test:micro` |
| 輕量 | 10 | 60秒 | 小班教學 | `npm run test:light` |
| 中等 | 25 | 120秒 | 中型研討會 | `npm run test:medium` |
| 重度 | 50 | 120秒 | 大班課程 | `npm run test:heavy` |
| 壓力 | 100 | 180秒 | 大型講座 | `npm run test:stress` |
| 極限 | 200 | 300秒 | 超大型活動 | `npm run test:extreme` |

## 📈 性能指標

測試會收集以下指標：

### 連接指標
- 成功連接數 / 失敗連接數
- 平均連接時間
- 最快/最慢連接時間

### 通信指標
- 發送消息數
- 接收消息數
- Presence 更新次數
- 消息吞吐量（每秒）

### 可靠性指標
- 錯誤總數
- 錯誤率
- 成功率

## 🎯 預期容量評估

### 基於 Supabase Free Plan

| 並發用戶 | 預期表現 | 建議 |
|----------|---------|------|
| 10-30 | ✅ 優秀 | 小型活動穩定使用 |
| 30-80 | ✅ 良好 | 中型活動可用 |
| 80-150 | ⚠️ 需優化 | 需要性能優化 |
| 150+ | ❌ 不推薦 | 建議升級計劃 |

**安全並發容量**: 50-100 用戶

### 基於 Supabase Pro Plan

| 並發用戶 | 預期表現 | 建議 |
|----------|---------|------|
| 50-150 | ✅ 優秀 | 穩定使用 |
| 150-300 | ✅ 良好 | 可以支持 |
| 300-400 | ⚠️ 需優化 | 接近上限 |
| 400+ | ❌ 需升級 | 考慮 Team 計劃 |

**安全並發容量**: 200-300 用戶

## 🔍 測試結果解讀

### ✅ 優秀表現
```
成功率: ≥ 99%
連接時間: < 500ms
錯誤率: < 1%
```
**建議**: 可以嘗試更高並發數

### ⚠️ 良好表現
```
成功率: 95-99%
連接時間: 500-1000ms
錯誤率: 1-5%
```
**建議**: 這是當前容量上限，需要監控

### ❌ 需要優化
```
成功率: < 95%
連接時間: > 1000ms
錯誤率: > 5%
```
**建議**: 超出容量，需要優化或降低並發

## 🛠️ 使用方法

### 快速開始

```bash
# 1. 進入測試目錄
cd load-testing

# 2. 安裝依賴
npm install

# 3. 配置環境變量
cp .env.example .env
# 編輯 .env，填入 Supabase 配置

# 4. 運行測試
npm start  # 互動式選擇
```

### 進階使用

```bash
# 運行特定場景
npm run test:light    # 10 用戶
npm run test:medium   # 25 用戶
npm run test:heavy    # 50 用戶

# 批量測試
npm run test:batch

# 自定義測試
node test-runner.js --users 30 --duration 90 --rampup 15
```

## 📊 測試報告

測試完成後會生成兩種報告：

1. **控制台輸出**: 即時查看測試結果和建議
2. **JSON 報告**: 保存在 `reports/` 目錄，包含完整數據

報告內容：
- 測試摘要（用戶數、成功率等）
- 性能指標（連接時間、消息數等）
- 並發性能評估
- 結論與優化建議

## 💡 最佳實踐

1. **階段性測試**: 從小規模開始，逐步增加並發數
2. **多次測試**: 每個級別測試 2-3 次取平均值
3. **真實環境**: 在接近生產環境的條件下測試
4. **定期測試**: 每次重大更新後都要測試
5. **預留空間**: 實際使用時保持在測試容量的 70-80%

## 🚨 注意事項

1. **測試環境**: 建議使用獨立的測試 Event，避免影響生產數據
2. **Supabase 限制**: 注意你的 Supabase 計劃的並發限制
3. **網絡影響**: 測試結果受網絡環境影響
4. **成本考量**: 大量測試可能產生 API 調用費用（Free plan 通常免費）

## 📚 文檔索引

- **[QUICK_START.md](load-testing/QUICK_START.md)**: 5分鐘快速開始
- **[README.md](load-testing/README.md)**: 完整使用文檔
- **[CAPACITY_GUIDE.md](load-testing/CAPACITY_GUIDE.md)**: 容量評估指南

## 🎓 測試流程示例

### 首次評估（推薦）

```bash
# 第1步: 基礎測試 (5-10 用戶)
npm run test:micro

# 第2步: 如果成功，增加到 25 用戶
npm run test:medium

# 第3步: 如果仍然成功，增加到 50 用戶
npm run test:heavy

# 第4步: 評估結果，確定最大容量
```

### 完整評估

```bash
# 運行批量測試，自動測試 10/25/50/100 用戶
npm run test:batch
```

## 🔧 技術架構

### 技術棧
- **Node.js**: 測試腳本運行環境
- **@supabase/supabase-js**: Supabase 客戶端
- **ES Modules**: 現代 JavaScript 模組系統

### 測試原理
1. 創建多個 Supabase 客戶端實例（模擬多個用戶）
2. 建立 Realtime Presence 和 Broadcast 連接
3. 模擬用戶互動（更新狀態、發送消息）
4. 收集性能指標（連接時間、消息延遲、錯誤等）
5. 分析數據並生成報告

## 📞 問題排查

### 常見問題

1. **連接失敗**: 檢查 Supabase 配置和 Event ID
2. **測試卡住**: 降低並發數或增加間隔時間
3. **錯誤率高**: 可能達到系統容量上限

詳見 `load-testing/README.md` 的故障排除章節。

## 🎯 後續優化建議

基於測試結果，可能的優化方向：

1. **應用層優化**:
   - 減少不必要的實時訂閱
   - 優化消息發送頻率
   - 實施客戶端緩存

2. **基礎設施優化**:
   - 升級 Supabase 計劃
   - 使用 CDN 加速
   - 優化數據庫查詢

3. **架構優化**:
   - 實施分組/分區策略
   - 添加限流機制
   - 考慮負載均衡

## 📊 結論

通過這套完整的負載測試系統，你可以：

- ✅ 快速評估系統可以支持多少並發用戶
- ✅ 為不同規模的活動做容量規劃
- ✅ 識別性能瓶頸並優化系統
- ✅ 建立性能監控基準
- ✅ 為升級決策提供數據支持

**立即開始測試**:
```bash
cd load-testing && npm install && npm start
```

---

**建議下一步**:
1. 設置環境變量並運行首次測試
2. 根據結果調整並發策略
3. 建立定期測試機制
4. 根據業務增長調整容量規劃
